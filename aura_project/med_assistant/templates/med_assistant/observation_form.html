{% extends 'med_assistant/base.html' %}

{% block title %}Nouvelle observation - AURA Medical AI{% endblock %}
{% block page_title %}Nouvelle observation{% endblock %}
{% block page_subtitle %}Cr√©er une nouvelle observation m√©dicale{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <form method="post" enctype="multipart/form-data" class="flex-1 flex flex-col space-y-4">
        {% csrf_token %}
        
        <!-- Patient Selection - Compact -->
        <div class="medical-card rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex-1 max-w-md">
                    <label for="{{ form.patient.id_for_label }}" class="block text-sm font-medium text-primary-dark mb-2">
                        <i class="fas fa-user mr-2 text-primary-steel"></i>
                        Patient
                    </label>
                    {{ form.patient }}
                    {% if form.patient.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.patient.errors %}
                                <p><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="ml-4">
                    <a href="{% url 'med_assistant:patient_create' %}" 
                       class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>Nouveau patient</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content - Flexible Height -->
        <div class="medical-card rounded-lg flex-1 flex flex-col p-6">
            
            <!-- Header with Recording Controls - Compact -->
            <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200">
                <div>
                    <h2 class="text-lg font-semibold text-primary-dark">
                        <i class="fas fa-file-medical mr-2 text-primary-steel"></i>
                        Observation m√©dicale
                    </h2>
                    <p class="text-sm text-gray-600">Dictez ou saisissez votre observation</p>
                </div>
                
                <!-- Recording Controls -->
                <div class="flex items-center space-x-3">
                    <button type="button" id="recordBtn" 
                            class="w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-microphone text-lg"></i>
                    </button>
                    
                    <button type="button" id="stopBtn" style="display: none;"
                            class="w-12 h-12 bg-gray-600 hover:bg-gray-700 text-white rounded-full flex items-center justify-center transition-all shadow-md">
                        <i class="fas fa-stop text-lg"></i>
                    </button>
                    
                    <div id="recordingInfo" style="display: none;" class="text-center">
                        <div id="timer" class="text-lg font-mono font-bold text-red-600">00:00</div>
                        <div class="text-xs text-gray-600">Enregistrement...</div>
                    </div>
                </div>
            </div>

            <!-- Audio Player (when recording is done) - Compact -->
            <div id="audioSection" style="display: none;" class="mb-4 p-3 bg-primary-light/10 rounded-lg border border-primary-light">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-primary-dark">
                        <i class="fas fa-volume-up mr-2"></i>
                        Enregistrement termin√©
                    </h3>
                    <button type="button" id="transcribeBtn" 
                            class="btn-primary px-3 py-1 rounded text-sm font-medium">
                        <i class="fas fa-magic mr-1"></i>
                        Transcrire
                    </button>
                </div>
                <audio id="audioPlayer" controls class="w-full h-8"></audio>
            </div>

            <!-- GRANDE ZONE DE TEXTE - Prend tout l'espace restant -->
            <div class="flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <label for="{{ form.texte_saisi.id_for_label }}" class="text-sm font-medium text-primary-dark">
                        <i class="fas fa-edit mr-2 text-primary-steel"></i>
                        Note m√©dicale
                    </label>
                    <div class="text-xs text-gray-500">
                        <span id="charCount">0 caract√®res</span>
                    </div>
                </div>
                
                <!-- TEXTAREA QUI PREND TOUT L'ESPACE DISPONIBLE -->
                <textarea name="{{ form.texte_saisi.name }}" 
                          id="{{ form.texte_saisi.id_for_label }}"
                          class="flex-1 w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-steel focus:border-primary-steel transition-colors resize-none"
                          style="min-height: 300px; font-family: 'Inter', sans-serif; font-size: 14px; line-height: 1.5;"
                          placeholder="Saisissez ou dictez votre observation m√©dicale ici...

Vous pouvez :
‚Ä¢ Utiliser l'enregistrement vocal (bouton microphone)
‚Ä¢ Saisir directement au clavier
‚Ä¢ Importer un fichier audio ci-dessous

Structure sugg√©r√©e :
‚Ä¢ Motif de consultation
‚Ä¢ Ant√©c√©dents m√©dicaux
‚Ä¢ Examen clinique
‚Ä¢ Diagnostic
‚Ä¢ Traitement prescrit
‚Ä¢ Suivi recommand√©">{{ form.texte_saisi.value|default_if_none:"" }}</textarea>
                
                {% if form.texte_saisi.errors %}
                    <div class="mt-2 text-xs text-red-600">
                        {% for error in form.texte_saisi.errors %}
                            <p><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- File Upload - Compact et bien int√©gr√© -->
        <div class="medical-card rounded-lg p-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary-steel/10 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-file-audio text-primary-steel"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-primary-dark mb-1">Importer un fichier audio</h3>
                    <div class="flex items-center space-x-3">
                        {{ form.audio_file }}
                        <span class="text-xs text-gray-500">MP3, WAV, OGG, M4A, WebM</span>
                    </div>
                    {% if form.audio_file.errors %}
                        <div class="mt-1 text-xs text-red-600">
                            {% for error in form.audio_file.errors %}
                                <p><i class="fas fa-exclamation-circle mr-1"></i>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- AI Info - Compact avec les bonnes couleurs -->
        <div class="stat-card rounded-lg p-4 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-semibold mb-1 flex items-center">
                        <i class="fas fa-robot mr-2"></i>
                        Analyse automatique AURA
                    </h3>
                    <p class="text-xs text-white/90">L'IA analysera automatiquement votre observation</p>
                </div>
                <div class="flex space-x-2">
                    <div class="bg-white/20 rounded px-2 py-1 text-xs">Whisper</div>
                    <div class="bg-white/20 rounded px-2 py-1 text-xs">CamemBERT</div>
                    <div class="bg-white/20 rounded px-2 py-1 text-xs">DrBERT</div>
                    <div class="bg-white/20 rounded px-2 py-1 text-xs">T5</div>
                </div>
            </div>
        </div>

        <!-- Form Errors -->
        {% if form.non_field_errors %}
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                {% for error in form.non_field_errors %}
                    <p class="text-sm text-red-600">
                        <i class="fas fa-exclamation-circle mr-1"></i>{{ error }}
                    </p>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Action Buttons - Fixed at bottom -->
        <div class="flex justify-between items-center pt-4 border-t border-gray-200">
            <a href="{% url 'med_assistant:dashboard' %}" 
               class="btn-secondary px-6 py-2 rounded-lg text-sm font-medium">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </a>
            <button type="submit" 
                    class="btn-primary px-8 py-2 rounded-lg text-sm font-medium shadow-md hover:shadow-lg">
                <i class="fas fa-save mr-2"></i>
                Cr√©er et analyser
            </button>
        </div>
    </form>
</div>

<script>
// Variables globales
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let startTime = 0;
let timerInterval = null;
let currentStream = null;

document.addEventListener('DOMContentLoaded', function() {
    // √âl√©ments DOM
    const texteField = document.querySelector('#{{ form.texte_saisi.id_for_label }}');
    const audioField = document.querySelector('#{{ form.audio_file.id_for_label }}');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioSection = document.getElementById('audioSection');
    const recordingInfo = document.getElementById('recordingInfo');
    const timer = document.getElementById('timer');
    const charCount = document.getElementById('charCount');
    const form = document.querySelector('form');
    
    // Compteur de caract√®res
    function updateCharCount() {
        const count = texteField.value.length;
        charCount.textContent = count + ' caract√®res';
    }
    
    texteField.addEventListener('input', updateCharCount);
    updateCharCount();
    
    // Fonction pour ajouter du texte dans la textarea
    function appendToTextArea(text, source = 'Transcription') {
        const currentText = texteField.value.trim();
        const separator = currentText ? '\n\n--- ' + source + ' ---\n' : '--- ' + source + ' ---\n';
        const newText = currentText + separator + text;
        
        texteField.value = newText;
        updateCharCount();
        
        // Scroll vers la fin
        texteField.scrollTop = texteField.scrollHeight;
        
        // Animation de highlight
        texteField.style.backgroundColor = '#dbeafe';
        setTimeout(() => {
            texteField.style.backgroundColor = '';
        }, 2000);
    }
    
    // Timer d'enregistrement
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Fonction pour arr√™ter compl√®tement l'enregistrement
    function stopRecording() {
        console.log('üõë Arr√™t de l\'enregistrement...');
        
        // Arr√™ter le MediaRecorder
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            console.log('üìπ Arr√™t du MediaRecorder (√©tat:', mediaRecorder.state, ')');
            mediaRecorder.stop();
        }
        
        // Arr√™ter toutes les pistes du stream
        if (currentStream) {
            console.log('üé§ Arr√™t des pistes audio...');
            currentStream.getTracks().forEach(track => {
                track.stop();
                console.log('‚úÖ Piste arr√™t√©e:', track.kind);
            });
            currentStream = null;
        }
        
        // R√©initialiser l'interface
        resetRecordingUI();
        
        console.log('‚úÖ Enregistrement compl√®tement arr√™t√©');
    }
    
    // R√©initialiser l'interface d'enregistrement
    function resetRecordingUI() {
        isRecording = false;
        recordBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        recordingInfo.style.display = 'none';
        
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // R√©initialiser le timer
        timer.textContent = '00:00';
    }
    
    // D√©marrer l'enregistrement
    recordBtn.addEventListener('click', async function() {
        try {
            console.log('üé§ Demande d\'acc√®s au microphone...');
            
            // Arr√™ter tout enregistrement en cours
            if (isRecording) {
                stopRecording();
                return;
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                } 
            });
            
            currentStream = stream;
            console.log('‚úÖ Microphone accessible, cr√©ation du MediaRecorder...');
            
            // Cr√©er le MediaRecorder
            const options = {};
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                options.mimeType = 'audio/webm;codecs=opus';
            } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                options.mimeType = 'audio/webm';
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                options.mimeType = 'audio/mp4';
            }
            
            mediaRecorder = new MediaRecorder(stream, options);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = function(event) {
                console.log('üìä Donn√©es audio re√ßues:', event.data.size, 'bytes');
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                console.log('üî¥ MediaRecorder arr√™t√©, cr√©ation du blob...');
                
                if (audioChunks.length === 0) {
                    console.warn('‚ö†Ô∏è Aucune donn√©e audio collect√©e');
                    return;
                }
                
                const audioBlob = new Blob(audioChunks, { 
                    type: mediaRecorder.mimeType || 'audio/wav' 
                });
                
                console.log('‚úÖ Blob cr√©√©:', audioBlob.size, 'bytes');
                
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioSection.style.display = 'block';
                
                // Cr√©er un fichier pour le formulaire
                const file = new File([audioBlob], 'recording.wav', { 
                    type: 'audio/wav' 
                });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                audioField.files = dataTransfer.files;
                
                console.log('‚úÖ Fichier ajout√© au formulaire');
            };
            
            mediaRecorder.onerror = function(event) {
                console.error('‚ùå Erreur MediaRecorder:', event.error);
                alert('Erreur lors de l\'enregistrement: ' + event.error);
                stopRecording();
            };
            
            // D√©marrer l'enregistrement
            mediaRecorder.start(1000); // Collecter les donn√©es toutes les secondes
            console.log('üî¥ Enregistrement d√©marr√©');
            
            // Mettre √† jour l'interface
            isRecording = true;
            recordBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            recordingInfo.style.display = 'block';
            
            // D√©marrer le timer
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
        } catch (error) {
            console.error('‚ùå Erreur d\'acc√®s au microphone:', error);
            
            let message = 'Impossible d\'acc√©der au microphone. ';
            if (error.name === 'NotAllowedError') {
                message += 'Veuillez autoriser l\'acc√®s au microphone dans votre navigateur.';
            } else if (error.name === 'NotFoundError') {
                message += 'Aucun microphone d√©tect√©.';
            } else {
                message += 'Erreur: ' + error.message;
            }
            
            alert(message);
            resetRecordingUI();
        }
    });
    
    // Arr√™ter l'enregistrement
    stopBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üõë Clic sur le bouton d\'arr√™t');
        stopRecording();
    });
    
    // Transcrire l'enregistrement
    transcribeBtn.addEventListener('click', function() {
        transcribeBtn.disabled = true;
        transcribeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Transcription...';
        
        // Simulation de transcription (remplacer par vraie API)
        setTimeout(() => {
            const mockTranscriptions = [
                "Patient pr√©sente des douleurs thoraciques depuis ce matin. Tension art√©rielle √©lev√©e √† 160/95. Prescrit un ECG et analyses sanguines.",
                "Consultation de suivi pour diab√®te de type 2. Glyc√©mie √† jeun √† 1,45 g/L. Ajustement de la metformine √† 1000mg matin et soir.",
                "Patient anxieux, troubles du sommeil depuis 3 semaines. Prescrit anxiolytique l√©ger et suivi psychologique.",
                "Douleur abdominale chronique, suspicion de gastrite. Prescription d'IPP et fibroscopie √† programmer.",
                "Examen de routine. Patient en bonne sant√© g√©n√©rale. Vaccination √† jour. Prochain rendez-vous dans 6 mois."
            ];
            
            const transcription = mockTranscriptions[Math.floor(Math.random() * mockTranscriptions.length)];
            appendToTextArea(transcription, 'Enregistrement vocal transcrit');
            
            transcribeBtn.disabled = false;
            transcribeBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Transcrit';
            transcribeBtn.className = 'px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition-colors';
        }, 2000);
    });
    
    // Gestion du fichier audio upload√©
    audioField.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            console.log('üìÅ Fichier s√©lectionn√©:', file.name, file.size, 'bytes');
            
            // Simulation de transcription pour les fichiers upload√©s
            setTimeout(() => {
                const mockTranscriptions = [
                    "Transcription du fichier audio: Patient pr√©sente des sympt√¥mes de fatigue chronique. Examens compl√©mentaires √† pr√©voir.",
                    "Transcription du fichier audio: Consultation post-op√©ratoire. Cicatrisation normale. Retrait des fils dans 7 jours.",
                    "Transcription du fichier audio: Contr√¥le tension art√©rielle. Valeurs normalis√©es sous traitement. Poursuite du protocole."
                ];
                
                const transcription = mockTranscriptions[Math.floor(Math.random() * mockTranscriptions.length)];
                appendToTextArea(transcription, 'Fichier ' + file.name + ' transcrit');
            }, 1500);
        }
    });
    
    // Validation du formulaire
    form.addEventListener('submit', function(e) {
        // Arr√™ter l'enregistrement si en cours
        if (isRecording) {
            e.preventDefault();
            alert('Veuillez arr√™ter l\'enregistrement avant de soumettre le formulaire.');
            return false;
        }
        
        const hasText = texteField.value.trim().length > 0;
        const hasAudio = audioField.files.length > 0;
        const hasRecording = audioPlayer.src && audioPlayer.src !== window.location.href;
        
        if (!hasText && !hasAudio && !hasRecording) {
            e.preventDefault();
            alert('Veuillez fournir soit un texte, soit un fichier audio, soit un enregistrement.');
            return false;
        }
        
        if (hasText && texteField.value.trim().length < 10) {
            e.preventDefault();
            alert('La note m√©dicale doit contenir au moins 10 caract√®res.');
            return false;
        }
    });
    
    // Nettoyage √† la fermeture de la page
    window.addEventListener('beforeunload', function() {
        if (isRecording) {
            stopRecording();
        }
    });
    
    // Gestion des raccourcis clavier
    document.addEventListener('keydown', function(e) {
        // Espace pour d√©marrer/arr√™ter l'enregistrement (si pas dans un champ de texte)
        if (e.code === 'Space' && !e.target.matches('input, textarea, select')) {
            e.preventDefault();
            if (isRecording) {
                stopRecording();
            } else {
                recordBtn.click();
            }
        }
        
        // √âchap pour arr√™ter l'enregistrement
        if (e.code === 'Escape' && isRecording) {
            e.preventDefault();
            stopRecording();
        }
    });
    
    console.log('‚úÖ Script d\'enregistrement initialis√©');
});
</script>
{% endblock %}